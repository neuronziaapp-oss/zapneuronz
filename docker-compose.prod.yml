version: "3.9"

services:
  backend:
    build:
      context: ./backend
    environment:
      - NODE_ENV=production
      - FRONTEND_URL=https://${TRAEFIK_FRONTEND_HOST:-app.example.com}
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD:-}
      - DB_STORAGE=/data/database.sqlite
      - UPLOAD_PATH=/app/uploads
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_SERVICE_KEY=${SUPABASE_SERVICE_KEY}
      - SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY}
      - JWT_SECRET=${JWT_SECRET}
      - IFRAME_API_KEY=${IFRAME_API_KEY}
      - ALLOW_USER_REGISTRATION=${ALLOW_USER_REGISTRATION:-false}
      - IFRAME_MODE=${IFRAME_MODE:-true}
      - EVOLUTION_API_URL=${EVOLUTION_API_URL}
      - EVOLUTION_API_KEY=${EVOLUTION_API_KEY}
      - EVOLUTION_CALL_REJECT_MESSAGE=${EVOLUTION_CALL_REJECT_MESSAGE:-Este número não aceita chamadas. Por favor, envie uma mensagem.}
      - DEFAULT_ADMIN_EMAIL=${DEFAULT_ADMIN_EMAIL}
      - DEFAULT_ADMIN_PASSWORD=${DEFAULT_ADMIN_PASSWORD}
      - WEBHOOK_URL=${WEBHOOK_URL:-https://${TRAEFIK_BACKEND_HOST:-api.example.com}/webhook}
      - WEBHOOK_EVENTS=${WEBHOOK_EVENTS:-APPLICATION_STARTUP,QRCODE_UPDATED,MESSAGES_UPSERT,MESSAGES_UPDATE,SEND_MESSAGE,CONNECTION_UPDATE,CONTACTS_UPSERT,CHATS_UPSERT}
      - WHITELIST_ENABLED=${WHITELIST_ENABLED:-false}
    volumes:
      - backend_data:/data
      - backend_uploads:/app/uploads
    labels:
      - "traefik.enable=true"
      - "traefik.http.services.wpp-backend.loadbalancer.server.port=3001"
      - "traefik.http.routers.wpp-backend.rule=Host(`${TRAEFIK_BACKEND_HOST:-api.example.com}`)"
      - "traefik.http.routers.wpp-backend.entrypoints=websecure"
      - "traefik.http.routers.wpp-backend.tls=true"
      - "traefik.http.routers.wpp-backend.tls.certresolver=leresolver"
      - "traefik.http.routers.wpp-backend.service=wpp-backend"
    depends_on:
      - redis
    networks:
      - internal
      - neurons-app
      - default

  frontend:
    build:
      context: ./frontend
      args:
        REACT_APP_API_URL: https://${TRAEFIK_BACKEND_HOST:-api.example.com}
        REACT_APP_SUPABASE_URL: ${REACT_APP_SUPABASE_URL:-https://your-project.supabase.co}
        REACT_APP_SUPABASE_ANON_KEY: ${REACT_APP_SUPABASE_ANON_KEY:-your-anon-key}
        REACT_APP_API_KEY: ${REACT_APP_API_KEY:-your-iframe-api-key}
        REACT_APP_WS_URL: wss://${TRAEFIK_BACKEND_HOST:-api.example.com}
        REACT_APP_SOCKET_URL: wss://${TRAEFIK_BACKEND_HOST:-api.example.com}
        REACT_APP_NOTIFICATION_TIMEOUT: ${REACT_APP_NOTIFICATION_TIMEOUT:-5000}
        REACT_APP_DEBUG: ${REACT_APP_DEBUG:-false}
    labels:
      - "traefik.enable=true"
      - "traefik.http.services.wpp-frontend.loadbalancer.server.port=80"
      - "traefik.http.routers.wpp-frontend.rule=Host(`${TRAEFIK_FRONTEND_HOST:-app.example.com}`)"
      - "traefik.http.routers.wpp-frontend.entrypoints=websecure"
      - "traefik.http.routers.wpp-frontend.tls=true"
      - "traefik.http.routers.wpp-frontend.tls.certresolver=leresolver"
      - "traefik.http.routers.wpp-frontend.service=wpp-frontend"
    depends_on:
      - backend
    networks:
      - internal
      - neurons-app

  redis:
    image: redis:7-alpine
    command: ["redis-server", "--save", "", "--appendonly", "no"]
    volumes:
      - redis_data:/data
    networks:
      - internal


volumes:
  backend_data:
  backend_uploads:
  redis_data:

networks:
  internal:
    driver: bridge
    internal: false
  neurons-app:
    external: true
